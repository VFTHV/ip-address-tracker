<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- displays site properly based on user's device -->

    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./images/favicon-32x32.png"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
      integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
      integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
      crossorigin=""
    ></script>
    <link rel="stylesheet" href="styles.css" />

    <title>IP Address Tracker</title>
  </head>
  <body>
    <section class="input-output">
      <h5 id="error-message" class="form-label"></h5>
      <div class="form-centered">
        <form id="form">
          <label class="form-label" for="ip-input"> IP Address Tracker </label>
          <input
            name="ip-input"
            id="ip-input"
            type="text"
            placeholder="Search for any IP address or domain"
            class="form-input"
            autocomplete="off"
          />
          <button class="submit"><div class="arrow"></div></button>
        </form>
      </div>
      <ul class="output">
        <li class="data-column">
          <p class="data-name">IP address</p>
          <p id="ip" class="output-data">Loading...</p>
        </li>
        <li class="data-column">
          <p class="data-name">Location</p>
          <p class="output-data">
            <span id="city"> Loading...</span>
            ,
            <span id="state"> </span>
            <span id="zipcode"></span>
          </p>
        </li>
        <li class="data-column">
          <p class="data-name">Timezone</p>
          <p class="output-data">UTC: <span id="timezone">Loading...</span></p>
        </li>
        <li class="data-column">
          <p class="data-name">ISP</p>
          <p id="isp" class="output-data">Loading...</p>
        </li>
      </ul>
    </section>
    <div id="map"></div>
  </body>
  <script>
    const apiKey1 = "at_H4jvcSllOaRXGMkxSprwTfmSBuUB2";
    const apiKey2 = "at_tcvPspf3lf41NHU5OjHX4QwonW964";

    const ipfyFetch = (input) => {
      let usedIpOrDomain = "";

      if (!input) {
        usedIpOrDomain = ``;
      } else if (domainOrIp(input)) {
        usedIpOrDomain = `&domain=${input}`;
      } else {
        usedIpOrDomain = `&ipAddress=${input}`;
      }

      const url = `https://geo.ipify.org/api/v2/country,city?apiKey=${apiKey2}${usedIpOrDomain}`;
      const ipfy = fetch(url);
      return ipfy;
    };

    const domainOrIp = (input) => {
      if (!input) return;
      const expressionString =
        "^((?!-))(xn--)?[a-z0-9][a-z0-9-_]{0,61}[a-z0-9]{0,1}\.(xn--)?([a-z0-9\-]{1,61}|[a-z0-9-]{1,30}\.[a-z]{2,})$";
      const expression = new RegExp(expressionString);

      if (input.toLowerCase().match(expression)) {
        return true;
      } else {
        return false;
      }
    };

    const ip = document.getElementById("ip");
    const city = document.getElementById("city");
    const state = document.getElementById("state");
    const zipcode = document.getElementById("zipcode");
    const timezone = document.getElementById("timezone");
    const isp = document.getElementById("isp");
    const errorMessage = document.getElementById("error-message");

    // creating map here

    const map = L.map("map", {
      zoomControl: false,
    });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "Â© OpenStreetMap",
    }).addTo(map);

    const assignData = (data, ipAddress) => {
      errorMessage.innerText = "";
      const yours = ipAddress ? "" : " (Yours)";

      errorMessage.innerText = data.code ? data.messages : "";

      // if data.code === 402 i.e. bad request happenned, then put Unknown into the text

      ip.innerText = data.code ? "Unkown" : data.ip + yours;
      city.innerText = data.code ? "" : data.location.city;
      state.innerText = data.code ? "" : data.location.region;
      zipcode.innerText = data.code
        ? "Unkown"
        : data.location.postalCode + yours;
      timezone.innerText = data.code
        ? "Unkown"
        : data.location.timezone + yours;
      isp.innerText = data.code ? "Unkown" : data.isp + yours;
    };

    const onError = () => {
      alert("Unkown Error Occurred");
    };

    const fetchAndAssign = (ip) => {
      ipfyFetch(ip)
        .then((response) => response.json())
        // .then((data) => console.log(data));
        .then((data) => {
          assignData(data, ip);
          const lat = data.location.lat;
          const lng = data.location.lng;

          map.setView([lat, lng], 14);
        })
        .catch((error) => onError);
    };

    fetchAndAssign();

    const form = document.getElementById("form");

    form.addEventListener("submit", (event) => {
      event.preventDefault();
      const enteredData = event.target.elements["ip-input"].value;

      fetchAndAssign(enteredData);
    });
  </script>

  <!-- add offset value dynamically using the API -->
</html>
